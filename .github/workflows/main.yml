# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.19

    - name: Go fmt Check
      uses: Jerome1337/gofmt-action@v1.0.5
      with:
        gofmt-path: './'
        gofmt-flags: '-l -d'

    - name: Clone TongSuo repository
      uses: actions/checkout@v3
      with:
        repository: Tongsuo-Project/Tongsuo
        path: tongsuo
        ref: 8.3-stable

    - name: Build  Tongsuo
      run: cd tongsuo &&  ./config --prefix=/opt/tongsuo -Wl,-rpath,/opt/tongsuo/lib  enable-ssl-trace enable-ec_elgamal enable-ntls && make -j && make install

    - name: Check Tongsuo lib
      run: ls /opt/tongsuo/lib

    - name: Check Tongsuo binary
      run: ldd /opt/tongsuo/bin/openssl 

    - name: Go Mod
      run: go mod tidy

    - name: Go vet Check
      run: go vet ./...

    - name: Build
      run: go build

    - name: s_server help
      run: /opt/tongsuo/bin/openssl s_server --help 

    - name: Setup test
      run: nohup /opt/tongsuo/bin/openssl s_server -accept 127.0.0.1:4433 -enc_cert tongsuo/test_certs/double_cert/SE.cert.pem -enc_key tongsuo/test_certs/double_cert/SE.key.pem -sign_cert tongsuo/test_certs/double_cert/SS.cert.pem -sign_key tongsuo/test_certs/double_cert/SS.key.pem -enable_ntls -trace &

    - name: Test
      run: go test -exec "env LD_LIBRARY_PATH=/opt/tongsuo/lib" ./...

    - name: server log
      run: cat nohup.out
